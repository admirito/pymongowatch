#!/bin/sh
# config script for pymongowatch
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <config> `configure' <installed-version>
#        * <config> `reconfigure' <installed-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

case "$1" in
    configure|reconfigure)
	. /usr/share/debconf/confmodule

	# pymongowatch-install-mask has an --available-paths option
	# just for this purpose, but the config maintainer script will
	# be executed before package extraction and also it cannot
	# relay on any dependencies except debconf and core utilities
	# according to the specification. So we use a simple python3
	# script to find the available paths and fallback to a default
	# in case there were no python3 available.
	PATHS=$(python3 -c 'if True:
            import sys, os
            paths = []
            for path in sys.path:
                if not path: continue
                if os.path.isdir(os.path.join(path, "pymongo")): break
                paths += [path]
            if paths:
                sys.stdout.write(", ".join(paths))
            else:
                exit(1)
        ' 2>/dev/null || echo "/usr/local/lib/python3/dist-packages")

	DEFAULT_PATH=$(python3 -c 'if True:
            import sys, os
            default_path = ""
            for path in sys.path:
                if not path: continue
                if os.path.isdir(os.path.join(path, "pymongo")):
                    print(default_path)
                default_path = path
        ' 2>/dev/null || true)

        db_metaget pymongowatch/mask_install_path choices
        CHOICES=$RET

        if [ "${PATHS}, custom, none" != "$CHOICES" ]; then
	    db_subst pymongowatch/mask_install_path choices $PATHS
	    db_fset pymongowatch/mask_install_path seen false

	    if [ -n "$DEFAULT_PATH" ]; then
		db_get pymongowatch/mask_install_path
		if [ "$RET" = "none" ]; then
		    db_set pymongowatch/mask_install_path "$DEFAULT_PATH"
		fi
	    fi
	fi

	db_input high pymongowatch/mask_install_path || true
	db_go || true

	db_get pymongowatch/mask_install_path
	if [ "$RET" = custom ]; then
	    db_input high pymongowatch/custom_mask_install_path || true
	    db_go || true
	else
	    db_set pymongowatch/custom_mask_install_path ""
	fi

    ;;

    *)
        echo "config script called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
